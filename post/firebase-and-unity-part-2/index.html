<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Connecting Players with Firebase and Unity [Part 2] | willhart.io</title>


  <link rel="icon" type="image/x-icon" href="/icons/icon_light_32x32.png">

  
<meta name="description" content="Part 2 of a tutorial on hacking firebase support into Unity (for desktop builds). Posted on https://willhart.io" />
<meta property="og:description" content="Part 2 of a tutorial on hacking firebase support into Unity (for desktop builds)" />
<meta property="og:title" content="Connecting Players with Firebase and Unity [Part 2]" />
<meta property="og:url" content="https://willhart.io/post/firebase-and-unity-part-2/">
<meta property="og:type" content="article" />
<meta property="og:locale" content="en_AU" />


  <link rel="stylesheet" href="https://willhart.io/global.css?h=f83cd20cd0df26d72c2b" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sono:wght@200..800&display=swap" rel="stylesheet">

  

  <!-- Cloudflare Web Analytics -->
  <script defer src='https://static.cloudflareinsights.com/beacon.min.js'
    data-cf-beacon='{"token": "310f93cab66a42c5a328f246cc053025"}'></script>
  <!-- End Cloudflare Web Analytics -->

  <!-- Light/Dark theme toggling -->
  <script type="text/javascript">
    const storageKey = "websiteTheme";

    // apply theme once we have a DOM
    document.addEventListener("DOMContentLoaded", () => {
      applyTheme();
    })

    // a function that toggles between light and dark theme
    const toggleTheme = () => {
      localStorage.setItem(storageKey, localStorage.getItem(storageKey) === "d" ? "l" : "d" );
      applyTheme();
    }

    // a function that actually applies the theme
    const applyTheme = () => {
      const useDarkTheme = localStorage.getItem(storageKey) === "d";
      document.getElementsByTagName("html")[0].className = useDarkTheme ? "dark" : "";
      document.getElementById("theme-toggle").textContent = useDarkTheme ? "üîÜ" : "üåë";
    }
  </script>

  <script type="speculationrules">
  {
    "prerender": [
      { "where": { "selector_matches": "a" } }
    ]
  }
  </script></head>

<body>
  <nav id="header">
    <a href="/" aria-label="Website Logo and Link to Home Page">
      <div id="logo" >&nbsp;</div>
    </a>
    <span>
      <button type="button" id="theme-toggle" aria-label="Toggle Theme" onClick="toggleTheme()">üåë</button>
      <a class="header-item" href="/post">POSTS</a>
      <a class="header-item" href="/tag">TAGS</a>
      <span class="header-item hide-when-slim">|</span>
      <a class="header-item hide-when-slim" href="/tag/projects">PROJECTS</a>
      <a class="header-item hide-when-slim" href="/tag/gamedev">GAMEDEV</a>
      <a class="header-item hide-when-slim" href="/tag/electronics">ELECTRONICS</a>
    </span>
  </nav>

  

<div class="container col mb mt">
  <h1>Connecting Players with Firebase and Unity [Part 2]</h1>
  <div class="col txtsm">
    <span>Posted by Will Hart on 2017-02-23</span>
    <div>
      <span>See also:</span>
      
      <a class="txtsm mr" href="https://willhart.io/tag/code/">#code</a>
      
      <a class="txtsm mr" href="https://willhart.io/tag/gamedev/">#gamedev</a>
      
    </div>
  </div>
</div>



<article class="container col mblg"><h2 id="recap">Recap</h2>
<p>In the <a href="/post/firebase-and-unity-part-1">previous part</a> we looked at getting a
firebase database set up and importing the package into Unity. In this part we
are actually going to build out the ‚Äúgame‚Äù. If you don‚Äôt recall, in this example
we are going to have a button and a click counter stored on the server. It isn‚Äôt
going to be a particularly exciting game, but should be enough to get us started
on the real-time database path.</p>
<blockquote>
<p>A reminder again as well that Firebase only has official support for
Android/iOS build targets. I‚Äôve managed to be a bit hacky and get it working
in standalone, but please help me badger firebase directly for official
standalone support!</p>
</blockquote>
<h2 id="creating-a-ui">Creating a UI</h2>
<p>Our first step is to build up a simple UGUI interface. As I said in the first
part, I‚Äôm going to assume you know how to do this and gloss over it fairly
quickly.</p>
<p>I did these steps to get the UI setup:</p>
<ol>
<li>In the Lighting panel, remove the skybox</li>
<li>On the camera inspector, set the Clear Flags to Solid Colour and choose a
background colour</li>
<li>Create a UI <code>Canvas</code> in the scene</li>
<li>Add a <code>Button</code> and <code>Text</code> to the canvas and mess about with layout anchors
and text settings a bit so it looks like this:</li>
</ol>
<p><img src="https://willhart.io/post/firebase-and-unity-part-2/clickme.png" alt="The resulting Unity Scene" /></p>
<h2 id="creating-a-firebase-script">Creating a Firebase script</h2>
<p>The next step is to create a C# script for handling the firebase interaction. I
named it <code>FirebaseClickHandler</code>, and started off with the following empty class
definition:</p>
<pre data-lang="cs" style="background-color:#2b303b;color:#c0c5ce;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#b48ead;">namespace </span><span>FirebaseTest
</span><span>{
</span><span style="color:#b48ead;">#region </span><span style="color:#8fa1b3;">Dependencies
</span><span>
</span><span>    </span><span style="color:#b48ead;">using </span><span>Firebase;
</span><span>    </span><span style="color:#b48ead;">using </span><span>Firebase.Database;
</span><span>    </span><span style="color:#b48ead;">using </span><span>Firebase.Unity.Editor;
</span><span>    </span><span style="color:#b48ead;">using </span><span>UnityEngine;
</span><span>    </span><span style="color:#b48ead;">using </span><span>UnityEngine.UI;
</span><span>
</span><span>    </span><span style="color:#b48ead;">#endregion
</span><span>
</span><span>    </span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">FirebaseClickHandler </span><span style="color:#eff1f5;">: </span><span style="color:#a3be8c;">MonoBehaviour
</span><span style="color:#eff1f5;">    {
</span><span style="color:#eff1f5;">        [</span><span style="color:#bf616a;">SerializeField</span><span style="color:#eff1f5;">] </span><span style="color:#b48ead;">private </span><span style="color:#eff1f5;">Text </span><span style="color:#bf616a;">_counterText</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">private int </span><span style="color:#bf616a;">_count </span><span>= </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">private void </span><span style="color:#8fa1b3;">Update</span><span style="color:#eff1f5;">()
</span><span style="color:#eff1f5;">        {
</span><span style="color:#eff1f5;">            </span><span style="color:#bf616a;">_counterText</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">text </span><span>= </span><span style="color:#bf616a;">_count</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">ToString</span><span style="color:#eff1f5;">(</span><span>&quot;</span><span style="color:#a3be8c;">N0</span><span>&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">    }
</span><span>}
</span></code></pre>
<p>Most of this is just standard C# setup for a MonoBehaviour, apart from the two
<code>using</code> statements for <code>Firebase</code> and <code>Firebase.Unity.Editor</code>. We are storing a
reference to the <code>Text</code> UI element we created earlier, and in the <code>Update</code>
method we just set the value of the Text to our counter.</p>
<p>If we add the script to our <code>Canvas</code>, hook up the references to the text object
and hit play at this point, our counter should just read <code>0</code> as in our
screenshot above.</p>
<h2 id="getting-the-count-from-the-database">Getting the count from the database</h2>
<p>The next thing we want to do is connect to the database and get the current
count. We can connect in the editor by writing the following in Awake:</p>
<pre data-lang="cs" style="background-color:#2b303b;color:#c0c5ce;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#b48ead;">private void </span><span style="color:#8fa1b3;">Awake</span><span>()
</span><span>{
</span><span>  </span><span style="color:#bf616a;">FirebaseApp</span><span>.</span><span style="color:#bf616a;">DefaultInstance</span><span>.</span><span style="color:#bf616a;">SetEditorDatabaseUrl</span><span>(
</span><span>    &quot;</span><span style="color:#a3be8c;">https://wh-unity-test.firebaseio.com/</span><span>&quot;);
</span><span>}
</span></code></pre>
<p>So here we are setting an Editor URL for testing, which is just our firebase URL
that we can see in the firebase console.</p>
<p>To read and write data, firebase has the concept of <code>references</code>. These are
essentially URLs which point to specific paths or data in the database and can
be used as a notification when the linked data changes, or as a way to read or
write data on that path. Add a private field at the top of our class (below
<code>_count</code>) to store the database reference:</p>
<pre data-lang="cs" style="background-color:#2b303b;color:#c0c5ce;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#b48ead;">private </span><span>DatabaseReference </span><span style="color:#bf616a;">_counterRef</span><span>;
</span></code></pre>
<p>At the same time, why not change the default value of <code>_count</code> to -1, so that
we can see when our data is loaded from the database more easily. We can then
replace the <code>Awake</code> method with this:</p>
<pre data-lang="cs" style="background-color:#2b303b;color:#c0c5ce;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#b48ead;">private void </span><span style="color:#8fa1b3;">Awake</span><span>()
</span><span>{
</span><span>  </span><span style="color:#bf616a;">FirebaseApp</span><span>.</span><span style="color:#bf616a;">DefaultInstance</span><span>.</span><span style="color:#bf616a;">SetEditorDatabaseUrl</span><span>(
</span><span>    &quot;</span><span style="color:#a3be8c;">https://wh-unity-test.firebaseio.com/</span><span>&quot;);
</span><span>
</span><span>  </span><span style="color:#bf616a;">_counterRef </span><span>= </span><span style="color:#bf616a;">FirebaseDatabase</span><span>.</span><span style="color:#bf616a;">DefaultInstance
</span><span>        .</span><span style="color:#bf616a;">GetReference</span><span>(&quot;</span><span style="color:#a3be8c;">counter</span><span>&quot;);
</span><span>
</span><span>  </span><span style="color:#bf616a;">_counterRef</span><span>.</span><span style="color:#bf616a;">ValueChanged </span><span>+= </span><span style="color:#bf616a;">OnCountUpdated</span><span>;
</span><span>}
</span><span>
</span><span style="color:#b48ead;">private void </span><span style="color:#8fa1b3;">OnCountUpdated</span><span>(</span><span style="color:#b48ead;">object </span><span style="color:#bf616a;">sender</span><span>, ValueChangedEventArgs </span><span style="color:#bf616a;">e</span><span>)
</span><span>{
</span><span>  </span><span style="color:#b48ead;">throw </span><span>new System.NotImplementedException();
</span><span>}
</span></code></pre>
<p>If we run the code now, we should get a <code>NotImplementedException</code> thrown, so our
<code>OnCountUpdated</code> method is being called when we ‚Äúconnect‚Äù our reference to the
database!</p>
<p>Let‚Äôs implement the method now, so that we can display our value in the text. In
the body of the <code>OnCountUpdated</code> method, put the following:</p>
<pre data-lang="cs" style="background-color:#2b303b;color:#c0c5ce;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">e</span><span>.</span><span style="color:#bf616a;">DatabaseError </span><span>!= </span><span style="color:#d08770;">null</span><span>)
</span><span>{
</span><span>  </span><span style="color:#bf616a;">Debug</span><span>.</span><span style="color:#bf616a;">LogError</span><span>(</span><span style="color:#bf616a;">e</span><span>.</span><span style="color:#bf616a;">DatabaseError</span><span>.</span><span style="color:#bf616a;">Message</span><span>);
</span><span>  </span><span style="color:#b48ead;">return</span><span>;
</span><span>}
</span><span>
</span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">e</span><span>.</span><span style="color:#bf616a;">Snapshot </span><span>== </span><span style="color:#d08770;">null </span><span>|| </span><span style="color:#bf616a;">e</span><span>.</span><span style="color:#bf616a;">Snapshot</span><span>.</span><span style="color:#bf616a;">Value </span><span>== </span><span style="color:#d08770;">null</span><span>) \</span><span style="color:#bf616a;">_count </span><span>= </span><span style="color:#d08770;">0</span><span>;
</span><span style="color:#b48ead;">else </span><span>\</span><span style="color:#bf616a;">_count </span><span>= </span><span style="color:#b48ead;">int</span><span>.</span><span style="color:#bf616a;">Parse</span><span>(</span><span style="color:#bf616a;">e</span><span>.</span><span style="color:#bf616a;">Snapshot</span><span>.</span><span style="color:#bf616a;">Value</span><span>.</span><span style="color:#bf616a;">ToString</span><span>());
</span></code></pre>
<p>We check for an error, then set the value of our <code>_count</code> according to what the
database value returns. The return value is in the <code>Snapshot</code> variable. Note
that we check for <code>e.Snapshot == null</code> - this is important because if there
isn‚Äôt any data at the path, <code>e.Snapshot</code> will be null - this lets us set a
default.</p>
<blockquote>
<p><strong>NOTE</strong> ‚ÄúEmpty‚Äù database URLs will return null</p>
</blockquote>
<p>If you hit play in the editor, you should see the a bit of a pause, then the
text value should be set to 0 as there isn‚Äôt currently anything at the
<code>/counter</code> path:</p>
<p><img src="https://willhart.io/post/firebase-and-unity-part-2/browsefirebase.png" alt="The counter path is currently empty" /></p>
<p>While you are here, play around a bit - you can edit values in the database
through your browser. With the application running, change the count value to
some random numbers - the text field in the Unity game should update
automatically!</p>
<p>OK, I think we are now ready to move on to writing the counter value to the
database.</p>
<h2 id="writing-a-value-to-the-database">Writing a value to the database</h2>
<p>To write a value to the database, we use a similar approach to reading - i.e.
call a method on the <code>DatabaseReference</code> we created before. Add the following
public method to our <code>FirebaseClickHandler</code> class:</p>
<pre data-lang="cs" style="background-color:#2b303b;color:#c0c5ce;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">IncrementClickCounter</span><span>()
</span><span>{
</span><span>  </span><span style="color:#bf616a;">_counterRef</span><span>.</span><span style="color:#bf616a;">SetValueAsync</span><span>(</span><span style="color:#bf616a;">_count </span><span>+ </span><span style="color:#d08770;">1</span><span>);
</span><span>}
</span></code></pre>
<p>Link this to our <code>Button</code> via the click handler.</p>
<p><img src="https://willhart.io/post/firebase-and-unity-part-2/inspector.png" alt="Hook up the method in the click handler" /></p>
<p>This bit is fun :) Tweak your windows so you can see the Unity game and the
firebase console side by side. Run the game and click the button. Now as we are
subscribing an event in <code>Awake</code>, we probably need to make sure that it gets
unsubscribed <code>OnDestroy</code>:</p>
<pre data-lang="cs" style="background-color:#2b303b;color:#c0c5ce;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#b48ead;">private void </span><span style="color:#8fa1b3;">OnDestroy</span><span>()
</span><span>{
</span><span>  </span><span style="color:#bf616a;">_counterRef</span><span>.</span><span style="color:#bf616a;">ValueChanged </span><span>-= </span><span style="color:#bf616a;">OnCountUpdated</span><span>;
</span><span>}
</span></code></pre>
<p>At this stage, we have a workable system, albeit with two, fairly major issues:</p>
<ol>
<li>If you build and run the game, you get a DLL Not Found exception</li>
<li>As our <code>IncrementClickCounter</code> uses our local value of count and adds 1, then if 100 people update the database at exactly the same time, then we may lose some of the increments (more below)</li>
</ol>
<p>We‚Äôll start by addressing point #2, by using <code>Transactions</code>.</p>
<h2 id="transactions">Transactions</h2>
<p>To clarify the issue - we are using our local value of <code>_count</code>, for example
<code>_count = 6</code> to send a <code>SetValueAsync</code> request with the value <code>_count + 1</code>. If
tonnes of people do this request at the same time (say 100 people try to set it
to 7) then our database will say <code>counter = 7</code> when what we actually want it to
say is counter = 106 (it was originally 6 and 100 people want to increment it.
We can manage this kind of situation by using a transaction.</p>
<p>A transaction in firebase runs from a <code>Reference</code> and receives the current data
value as <code>MutableData</code>. It ‚Äúreturns‚Äù the new data that should be set in the
database. Lets replace our <code>IncrementClickCounter</code> method with the following:</p>
<pre data-lang="cs" style="background-color:#2b303b;color:#c0c5ce;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">IncrementClickCounter</span><span>()
</span><span>{
</span><span>  </span><span style="color:#bf616a;">_counterRef</span><span>.</span><span style="color:#bf616a;">RunTransaction</span><span>(</span><span style="color:#bf616a;">data </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>    </span><span style="color:#bf616a;">data</span><span>.</span><span style="color:#bf616a;">Value </span><span>= \</span><span style="color:#bf616a;">_count </span><span>+ </span><span style="color:#d08770;">1</span><span>;
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">TransactionResult</span><span>.</span><span style="color:#bf616a;">Success</span><span>(</span><span style="color:#bf616a;">data</span><span>);
</span><span>  }).</span><span style="color:#bf616a;">ContinueWith</span><span>(</span><span style="color:#bf616a;">task </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>    </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">task</span><span>.</span><span style="color:#bf616a;">Exception </span><span>!= </span><span style="color:#d08770;">null</span><span>)
</span><span>    </span><span style="color:#bf616a;">Debug</span><span>.</span><span style="color:#bf616a;">Log</span><span>(</span><span style="color:#bf616a;">task</span><span>.</span><span style="color:#bf616a;">Exception</span><span>.</span><span style="color:#bf616a;">ToString</span><span>());
</span><span>  });
</span><span>}
</span></code></pre>
<p>Its a tiny bit more code, but now our counter should be protected against race
conditions!</p>
<h2 id="building-for-desktop">Building for Desktop</h2>
<p>Now a few paragraphs ago, I glossed over a <code>DLLNotFound</code> exception above when we
ran the built version of our game. This is due to no official support for Unity
Standalone. If you create a development build and look at the debug logs, this
is because and <code>App.dll</code> is missing. Checking this is in my plugins directory,
but only for Android, iOS and x86_64 builds. By changing the standalone
architecture to <code>x86_64</code> I was able to get this file included as part of the
build, and compile and run our example game.</p>
<p><img src="https://willhart.io/post/firebase-and-unity-part-2/buildsettings.png" alt="Using x86_64 architecture" /></p>
<p>I also had to modify the connection script in <code>Awake</code>, to set the database path
explicitly. There may be a better way to load in config, but this worked for me
as a quick hack:</p>
<pre data-lang="cs" style="background-color:#2b303b;color:#c0c5ce;" class="language-cs "><code class="language-cs" data-lang="cs"><span style="color:#b48ead;">#if </span><span style="color:#d08770;">UNITY_EDITOR
</span><span>  </span><span style="color:#bf616a;">FirebaseApp</span><span>.</span><span style="color:#bf616a;">DefaultInstance</span><span>.</span><span style="color:#bf616a;">SetEditorDatabaseUrl</span><span>(
</span><span>    &quot;</span><span style="color:#a3be8c;">https://wh-unity-test.firebaseio.com/</span><span>&quot;);
</span><span style="color:#b48ead;">#else
</span><span>  </span><span style="color:#bf616a;">FirebaseApp</span><span>.</span><span style="color:#bf616a;">DefaultInstance</span><span>.</span><span style="color:#bf616a;">Options</span><span>.</span><span style="color:#bf616a;">DatabaseUrl </span><span>=
</span><span>    new System.Uri(&quot;</span><span style="color:#a3be8c;">https://wh-unity-test.firebaseio.com</span><span>&quot;);
</span><span style="color:#b48ead;">#endif
</span></code></pre>
<p>I haven‚Äôt experimented much, but I suspect that a lot of the extra features of
firebase such as authentication may be unsupported in Standalone mode. This does
leave our firebase data open to abuse. We can mitigate this a little bit by
doing some additional validation in our database rules:</p>
<pre data-lang="json" style="background-color:#2b303b;color:#c0c5ce;" class="language-json "><code class="language-json" data-lang="json"><span>&quot;</span><span style="color:#a3be8c;">.validate</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">newData.isNumber() &amp;&amp; newData.val() == data.val() + 1</span><span>&quot;
</span></code></pre>
<p>This means that the update will fail unless we are incrementing by one, which
should prevent people clearing or otherwise playing with the counter too much,
but at the end of the day without authentication we are a little open to
exploitation.</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>I really like firebase. I‚Äôve used it in some web apps and have been very
pleasantly surprised, and I‚Äôd be stoked to be able to base some features on it
in a Standalone build of a Unity game. If you feel the same way, please get in
touch with firebase and tell them!</p>
<p>Otherwise, I hope this has given you some insight into how firebase can be used
and setup!</p>
</article>

<div class="container col">
  <h2>Comments</h2>
  <blockquote>Comments are powered by github and <a href="https://giscus.app">giscus</a></blockquote>
  <script src="https://giscus.app/client.js"
        data-repo="will-hart/will-hart.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMjQ2NjY3Mzg="
        data-category="General"
        data-category-id="DIC_kwDOE1oFcs4CtiK6"
        data-mapping="og:title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
  </script>
</div>
</div>

  <footer id="footer">
    <div class="container col">
      This website was hand-made using Zola and Tera.
      All text and images are available under CC0 1.0 Universal and code under MIT unless otherwise specified. See <a href="https://github.com/will-hart/willhart.io/blob/main/LICENSE.md">LICENSE.md</a> for more.
    </div>
  </footer>
</body>

</html>
